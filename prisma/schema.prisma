// 1. Database Configuration for Railway
datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector] // Enable pgvector extension for similarity search
}

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

// 2. Product Identity (SKU 身份证)
model Product {
  id         String  @id @default(uuid())
  brand      String
  name       String
  priceUsd   Decimal @map("price_usd") @db.Decimal(10, 2)
  priceCny   Decimal @map("price_cny") @db.Decimal(10, 2)
  productUrl String? @map("product_url")
  imageUrl   String? @map("image_url")
  regionAvailability String[] @default([]) @map("region_availability")

  // Relations
  vectors     SkuVector?
  ingredients IngredientData?
  socialStats SocialStats?
  kbSnippets  ProductKbSnippet[]
  priceSnapshots ProductPriceSnapshot[]
  aliases ProductAlias[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([brand])
  @@index([name])
  @@map("products")
}

// 3. The Logic Core (SKU 基因组) - Most Critical Table
model SkuVector {
  id        String  @id @default(uuid())
  productId String  @unique @map("product_id")
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Mechanism Scores (0-100) - Stored as JSON for flexibility
  // Schema: { "oil_control": 85, "soothing": 20, "anti_aging": 90 }
  mechanism Json

  // Experience Factors - Stored as JSON
  // Schema: { "texture": "gel", "finish": "matte", "pilling_risk": 0.8 }
  experience Json

  // Risk Flags (e.g., ["alcohol", "strong_acid"])
  riskFlags String[] @map("risk_flags")

  // Vector Embedding for Dupe Discovery (1536 dimensions for OpenAI ada-002)
  // Note: Requires Prisma specific setup for vector types, using Unsupported for raw SQL mapping if needed,
  // but standard practice usually maps this via raw queries.
  // Here we define a field to hold it, but pgvector interaction is often done via raw SQL in API.
  embedding Unsupported("vector(1536)")?

  @@map("sku_vectors")
}

// 4. Ingredient Data (Source of Truth)
model IngredientData {
  id        String  @id @default(uuid())
  productId String  @unique @map("product_id")
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  fullList    String[] @map("full_list") // Ordered list
  heroActives Json     @map("hero_actives") // e.g. [{"name": "Retinol", "pct": "0.3%"}]

  @@map("ingredients")
}

// 5. Social Pulse (舆情指纹)
model SocialStats {
  id        String  @id @default(uuid())
  productId String  @unique @map("product_id")
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Platform specific scores (0-100)
  redScore    Int @default(0) @map("red_score")
  redditScore Int @default(0) @map("reddit_score")

  // Safety signal
  burnRate Decimal @default(0.0) @map("burn_rate") // 0.0 - 1.0

  topKeywords String[] @map("top_keywords") // e.g. ["假滑", "HolyGrail"]

  lastUpdated DateTime @default(now()) @map("last_updated")

  @@map("social_stats")
}

model ProductKbSnippet {
  id        String  @id @default(uuid())
  productId String  @map("product_id")
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  sourceSheet String @map("source_sheet")
  field       String
  content     String
  metadata    Json?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([productId, sourceSheet, field], map: "product_kb_snippets_product_sheet_field_uidx")
  @@index([productId])
  @@map("product_kb_snippets")
}

model ProductPriceSnapshot {
  id        String  @id @default(uuid())
  productId String  @map("product_id")
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Optional region scoping: "CN" | "US" | "EU" | "Global" | null
  region   String?
  currency String?

  // Monetary snapshots (nullable to allow partial sources)
  priceUsd Decimal? @map("price_usd") @db.Decimal(10, 2)
  priceCny Decimal? @map("price_cny") @db.Decimal(10, 2)

  // Provenance
  source     String
  sourceUrl  String? @map("source_url")
  confidence Float?
  metadata   Json?

  capturedAt DateTime @default(now()) @map("captured_at")

  @@index([productId])
  @@index([region])
  @@index([capturedAt])
  @@index([productId, region, capturedAt])
  @@map("product_price_snapshots")
}

model ProductAlias {
  id        String  @id @default(uuid())
  productId String  @map("product_id")
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  alias          String
  aliasNormalized String @map("alias_normalized")

  // Optional: "brand" | "name" | "full_name" | "nickname" | etc.
  kind   String?
  weight Int     @default(0)
  locale String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([productId, aliasNormalized], map: "product_aliases_product_alias_norm_uidx")
  @@index([aliasNormalized])
  @@index([productId])
  @@map("product_aliases")
}
